---
title: "Data Science HW-5"
author: "Kasturi Bhamidipati"
date: "2022-11-14"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggridges)
library(patchwork)
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 9, 
  fig.height = 7,
  out.width = "95%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 1


# Problem 2

## Importing the data

First we want to import the data. 

```{r import data}
homicide_raw = 
  read_csv(file = "./data/homicide-data.csv")
```

## Summary of the dataset 

- The `homicide` dataset has `r nrow(homicide_raw)` rows and `r ncol(homicide_raw)` columns. 
- It has the following variables: `r colnames(homicide_raw)`

## Creating `city_state` variable and summarizing

```{r city_state}
homicide_data = 
  homicide_raw%>%
  janitor::clean_names()%>%
  mutate(
    city_state = str_c(city,state, sep = ","),
    status = 
      case_when(
        disposition == "Closed without arrest" ~ "unsolved", 
        disposition == "Open/No arrest" ~ "unsolved", 
        disposition == "Closed by arrest" ~ "solved"
      ))%>%
  group_by(city_state)%>%
  summarise(
    total= n(), 
    unsolved = sum(status=="unsolved")
  )
```

## `prop.test` for Baltimore and saving output as R object

```{r prop test baltimore}
prop.test(
  homicide_data %>% filter(city_state == "Baltimore,MD") %>% 
    pull(unsolved),
  homicide_data %>% filter(city_state == "Baltimore,MD") %>% 
    pull(total)) %>% 
  broom::tidy()%>% 
  saveRDS(., "./data/Baltimore_prop_test.rds")
```

## `prop.test` for each city

```{r prop test all cities}
homicide_data_pt = 
  homicide_data%>%
  mutate(
    prop_df =map2(.x = unsolved, .y = total, ~prop.test(x = .x, n = .y)),
    tidied =map(.x = prop_df, ~broom::tidy(.x))
    ) %>% 
  select(-prop_df) %>% 
  unnest(tidied) %>% 
  select(city_state, estimate, conf.low,conf.high)

homicide_data_pt
```

## Plot for estimates and CIs for each city 

```{r plot, dpi=500}
homicide_plot = 
  homicide_data_pt%>% 
  ggplot(aes(x = fct_reorder(city_state, estimate), y = estimate))+ 
  geom_point()+
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
  labs(title = "Estimated proportions and 95% CIs of unsolved homicides, by city, in the US",
       x = "City (City, State)",
       y = "Estimated proportion and 95% CI")

homicide_plot

ggsave(path = "results", "homicide_plot.pdf")

```

# Problem 3 

## Setting up my simulation 

First I want to set up a simulation with the following design elements: n = 30, σ = 5 and μ = 0.

```{r simulation setup}

initial_sim = function(n = 30, sigma = 5, mu = 0) {
  x = rnorm(n, mean = mu, sd = sigma)
  t_test = t.test(x, conf.int = 0.95)%>%
    broom::tidy()
  
    t_test
}
```

## Generating 5000 datasets 

Now we want to generate 5000 datasets from the model. 

```{r 5000 sims}

simulations = vector("list", 1000)
for(i in 1:1000) {
  simulations[[i]]= initial_sim()
}

simulations = simulations %>%
  bind_rows()%>%
  head()
```

## Repeating the simulation for any `mu`

Now we want to repeat the above for μ={1,2,3,4,5,6}

```{r}
sim_mu = function(set){
  mu_output = vector("list", 1000)
  for (i in 1:1000) {
    mu_output[[i]] = initial_sim(mu = set)
  }
  power_output = 
    mu_output%>%
    bind_rows()%>%
    janitor::clean_names() %>% 
    select(estimate, p_value) %>% 
    filter(p_value < 0.05) %>% 
    count()
  
  power_output
}

# For power of the test 

test_power = 
  tibble(
    mu_vals = c(0,1,2,3,4,5,6), 
    reject_count= map(mu_vals, sim_mu)
  )%>% 
  unnest(reject_count)%>%
  mutate(power = n/1000)
```


 




